openapi: 3.0.0
info:
  title: Actual Server
  version: 1.0.2
  description: "Actual Budget sync server."
servers:
  - url: http://localhost:5006
    description: Local development
tags:
  - name: health-check
    description: health check endpoints
  - name: account
    description: account
  - name: sync
    description: sync
paths:
  "/info":
    get:
      summary: Displays application information.
      tags:
        - health-check
      responses:
        "200":
          description: Ok
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Info"
              examples:
                success:
                  $ref: "#/components/examples/info"
  "/health":
    get:
      summary: Shows application health information.
      tags:
        - health-check
      responses:
        "200":
          description: Ok
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Health"
              examples:
                success:
                  $ref: "#/components/examples/health"
  "/metrics":
    get:
      summary: Shows metrics information for the current application.
      tags:
        - health-check
      responses:
        "200":
          description: Ok
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Metrics"
              examples:
                success:
                  $ref: "#/components/examples/metrics"
  "/mode":
    get:
      summary: Shows the mode set in the current server configuration.
      tags:
        - health-check
      responses:
        "200":
          description: Ok
          content:
            text/html:
              schema:
                type: string
  "/account/needs-bootstrap":
    get:
      summary: returns bootstrap status
      tags:
        - account
      responses:
        "200":
          description: Ok
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                  data:
                    type: object
                    properties:
                      bootstrapped:
                        type: boolean
              examples:
                success:
                  value: { status: "ok", data: { bootstrapped: true } }
        "500":
          $ref: "#/components/responses/error-internal"
  "/account/bootstrap":
    post:
      summary: bootstrap the server
      tags:
        - account
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                password:
                  type: string
      responses:
        "200":
          description: Ok
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                  data:
                    type: object
                    properties:
                      token:
                        type: string
              examples:
                success:
                  $ref: "#/components/examples/token"
        "400":
          description: error
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                  reason:
                    type: string
              examples:
                already-bootstrapped:
                  value: { status: "error", reason: "already-bootstrapped" }
                invalid-password:
                  value: { status: "error", reason: "invalid-password" }
        "500":
          $ref: "#/components/responses/error-internal"
  "/account/login":
    post:
      summary: Logs in to the server
      tags:
        - account
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/Login"
      responses:
        "200":
          description: Ok
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                  data:
                    type: object
                    properties:
                      token:
                        type: string
                        nullable: true
              examples:
                success:
                  $ref: "#/components/examples/token"
                failure:
                  value: { status: "ok", data: { token: null } }
        "500":
          $ref: "#/components/responses/error-internal"
  "/account/change-password":
    post:
      summary: Update a user password
      tags:
        - account
      parameters:
        - $ref: "#/components/parameters/token-header"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              allOf:
                - $ref: "#/components/schemas/Login"
                - type: object
                  properties:
                    token:
                      type: string
                      nullable: true
      responses:
        "200":
          description: Ok
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                  data:
                    type: object
              examples:
                success:
                  value: { status: "ok", data: {} }
        "401":
          $ref: "#/components/responses/unauth-user"
        "500":
          $ref: "#/components/responses/error-internal"
  "/account/validate":
    get:
      summary: Validate account access
      tags:
        - account
      parameters:
        - $ref: "#/components/parameters/token-header"
      requestBody:
        # required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                token:
                  type: string
                  nullable: true
      responses:
        "200":
          description: Ok
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                  data:
                    type: object
                    properties:
                      validated:
                        type: boolean
              examples:
                success:
                  value: { status: "ok", data: { validated: true } }
        "401":
          $ref: "#/components/responses/unauth-user"
        "500":
          $ref: "#/components/responses/error-internal"
  "/sync/sync":
    post:
      # summary: TODO
      tags:
        - sync
      parameters:
        - $ref: "#/components/parameters/token-header"
      requestBody:
        description: Protobuf serialized sync request
        required: true
        content:
          application/octet-stream: {}
      responses:
        "200":
          description: Ok
          content:
            application/actual-sync: {}
        "400":
          description: Error
          content:
            text/html:
              schema:
                type: string
              examples:
                file-not-found:
                  value: file-not-found
                file-old-version:
                  value: file-old-version
                file-needs-upload:
                  value: file-needs-upload
                file-has-reset:
                  value: file-has-reset
                file-has-new-key:
                  value: file-has-new-key
        "401":
          $ref: "#/components/responses/unauth-user"
        "500":
          $ref: "#/components/responses/error-internal"
  "/sync/user-get-key":
    # TODO why exactly is this a POST and not a GET?
    post:
      # summary: TODO
      tags:
        - sync
      parameters:
        - $ref: "#/components/parameters/token-header"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                fileId:
                  type: string
      responses:
        "200":
          description: Ok
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                  data:
                    type: object
                    properties:
                      id:
                        type: string
                        nullable: true
                      salt:
                        type: string
                        nullable: true
                      test:
                        type: string
                        nullable: true
              examples:
                success:
                  value:
                    {
                      status: "ok",
                      data:
                        {
                          id: encrypt_keyid,
                          salt: encrypt_salt,
                          test: encrypt_test
                        }
                    }
        "400":
          description: Error
          content:
            text/html:
              schema:
                type: string
              examples:
                file-not-found:
                  value: file-not-found
        "500":
          $ref: "#/components/responses/error-internal"
  "/sync/user-create-key":
    post:
      # summary: TODO
      tags:
        - sync
      parameters:
        - $ref: "#/components/parameters/token-header"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                fileId:
                  type: string
                keyId:
                  type: string
                keySalt:
                  type: string
                testContent:
                  type: string
      responses:
        "200":
          $ref: "#/components/responses/ok-nodata"
        "500":
          $ref: "#/components/responses/error-internal"
  "/sync/reset-user-file":
    post:
      # summary: TODO
      tags:
        - sync
      parameters:
        - $ref: "#/components/parameters/token-header"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                fileId:
                  type: string
      responses:
        "200":
          $ref: "#/components/responses/ok-nodata"
        "400":
          description: Error
          content:
            text/html:
              schema:
                type: string
              examples:
                file-not-found:
                  value: User or file not found
        "500":
          $ref: "#/components/responses/error-internal"
  "/sync/upload-user-file":
    post:
      # summary: TODO
      tags:
        - sync
      parameters:
        - $ref: "#/components/parameters/token-header"
        - name: x-actual-file-id
          in: header
          required: true
          description: File ID
          schema:
            type: string
        - name: x-actual-group-id
          in: header
          required: false
          description: Group ID
          schema:
            type: string
        - name: x-actual-encrypt-meta
          in: header
          required: false
          description: Encryption metadata
          schema:
            # TODO: actually JSON with shape...?
            type: string
        - name: x-actual-format
          in: header
          required: false
          description: Sync format version
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/octet-stream: {}
      responses:
        "200":
          description: Ok or write error
          content:
            application/json:
              schema:
                oneOf:
                  - type: object
                    required: [status, groupId]
                    properties:
                      status:
                        type: string
                      groupId:
                        type: string
                  - type: object
                    additionalProperties: false
                    properties:
                      status:
                        type: string
              examples:
                success:
                  value: { status: "ok", groupId: "groupId" }
                write-err:
                  value: { status: "error" }
        "400":
          description: Error
          content:
            text/html:
              schema:
                type: string
              examples:
                file-has-reset:
                  value: file-has-reset
                file-has-new-key:
                  value: file-has-new-key
        "500":
          $ref: "#/components/responses/error-internal"
  "/sync/download-user-file":
    get:
      # summary: TODO
      tags:
        - sync
      parameters:
        - $ref: "#/components/parameters/token-header"
        - name: x-actual-file-id
          in: header
          required: true
          description: File ID
          schema:
            type: string
      responses:
        "200":
          description: Ok
          content:
            application/octet-stream: {}
        "400":
          description: Error
          content:
            text/html:
              schema:
                type: string
              examples:
                file-not-found:
                  value: User or file not found
        "500":
          description: Internal Server Error
          content:
            text/html:
              schema:
                type: string
              examples:
                read-err:
                  value: Error reading files
            application/json:
              schema:
                $ref: "#/components/schemas/ErrInternal"
              examples:
                err:
                  $ref: "#/components/examples/err-internal"
  "/sync/update-user-filename":
    post:
      # summary: TODO
      tags:
        - sync
      parameters:
        - $ref: "#/components/parameters/token-header"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                fileId:
                  type: string
                name:
                  type: string
      responses:
        "200":
          $ref: "#/components/responses/ok-nodata"
        "500":
          description: Internal Server Error
          content:
            text/html:
              schema:
                type: string
              examples:
                read-err:
                  value: User or file not found
            application/json:
              schema:
                $ref: "#/components/schemas/ErrInternal"
              examples:
                err:
                  $ref: "#/components/examples/err-internal"
  "/sync/list-user-files":
    get:
      # summary: TODO
      tags:
        - sync
      parameters:
        - $ref: "#/components/parameters/token-header"
      responses:
        "200":
          description: Ok
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                  data:
                    $ref: "#/components/schemas/FileList"
        "500":
          description: Internal Server Error
          content:
            text/html:
              schema:
                type: string
              examples:
                read-err:
                  value: Error reading files
            application/json:
              schema:
                $ref: "#/components/schemas/ErrInternal"
              examples:
                err:
                  $ref: "#/components/examples/err-internal"
  "/sync/get-user-file-info":
    get:
      # summary: TODO
      tags:
        - sync
      parameters:
        - $ref: "#/components/parameters/token-header"
        - name: x-actual-file-id
          in: header
          required: true
          description: File ID
          schema:
            type: string
      responses:
        "200":
          description: Ok
          content:
            application/json:
              schema:
                oneOf:
                  - type: object
                    required: [status, data]
                    properties:
                      status:
                        type: string
                      data:
                        $ref: "#/components/schemas/File"
                  - type: object
                    additionalProperties: false
                    properties:
                      status:
                        type: string
              examples:
                success:
                  value:
                    {
                      status: "ok",
                      data:
                        {
                          deleted: false,
                          fileId: "row.id",
                          groupId: "row.group_id",
                          name: "row.name",
                          encryptMeta: "row.encrypt_meta"
                        }
                    }
                no-rows:
                  value: { status: "error" }
        "500":
          $ref: "#/components/responses/error-internal"
  "/sync/delete-user-file":
    post:
      # summary: TODO
      tags:
        - sync
      parameters:
        - $ref: "#/components/parameters/token-header"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                fileId:
                  type: string
      responses:
        "200":
          $ref: "#/components/responses/ok-nodata"
        "500":
          $ref: "#/components/responses/error-internal"
components:
  schemas:
    Info:
      type: object
      properties:
        build:
          type: object
          properties:
            description:
              type: string
            name:
              type: string
            version:
              type: string
    Health:
      type: object
      properties:
        status:
          type: string
    Metrics:
      type: object
      properties:
        mem:
          type: object
          properties:
            heapTotal:
              type: number
            heapUsed:
              type: number
            rss:
              type: number
            external:
              type: number
            arrayBuffers:
              type: number
        uptime:
          type: number
    Login:
      type: object
      properties:
        password:
          type: string
      required:
        - password
    Ok:
      type: object
      properties:
        status:
          type: string
    ErrInternal:
      type: object
      properties:
        status:
          type: string
        reason:
          type: string
    File:
      type: object
      properties:
        deleted:
          type: boolean
        fileId:
          type: string
        groupId:
          type: string
        name:
          type: string
        encryptKeyId:
          type: string
    FileList:
      type: array
      items:
        $ref: "#/components/schemas/File"
  examples:
    info:
      value:
        {
          "build":
            {
              "description": "This is my new app",
              "name": "MyApp",
              "version": "1.0.0"
            },
          "git":
            {
              "branch": "master",
              "commit": { "id": "329a314", "time": "2016-11-18 08:16:39-0500" }
            }
        }
    health:
      value: { "status": "UP" }
    metrics:
      value:
        {
          "mem":
            { "heapTotal": 14659584, "heapUsed": 10615072, "rss": 30093312 },
          "uptime": 19.797
        }
    token:
      value: { status: "ok", data: { token: "token" } }
    err-internal:
      value: { status: "error", reason: "internal-error" }
  parameters:
    token-header:
      name: x-actual-token
      in: header
      required: false
      description: Session token, if not provided in the request body.
      schema:
        type: string
  responses:
    unauth-user:
      description: Unauthorized
      content:
        application/json:
          schema:
            type: object
            properties:
              status:
                type: string
              reason:
                type: string
              details:
                type: string
          examples:
            unauth:
              value:
                {
                  status: "error",
                  reason: "unauthorized",
                  details: "token-not-found"
                }
    error-internal:
      description: Internal Server Error
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrInternal"
          examples:
            err:
              $ref: "#/components/examples/err-internal"
    ok-nodata:
      description: Ok
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Ok"
          examples:
            success:
              value: { status: "ok" }
